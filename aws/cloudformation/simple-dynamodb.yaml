AWSTemplateFormatVersion: '2010-09-09'
Description: 'Food Ordering API - Simple Lambda with DynamoDB'

Parameters:
  TwilioAccountSid:
    Type: String
    Description: Twilio Account SID
    NoEcho: true
  
  TwilioAuthToken:
    Type: String
    Description: Twilio Auth Token
    NoEcho: true
  
  TwilioWhatsAppNumber:
    Type: String
    Default: 'whatsapp:+14155238886'
  
  TwilioSmsNumber:
    Type: String
  
  RestaurantWhatsAppNumber:
    Type: String
    Default: 'whatsapp:+919766007557'
  
  RestaurantSmsNumber:
    Type: String
    Default: '+919766007557'

Resources:
  # DynamoDB Table for Orders
  OrdersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: food-orders
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: orderId
          AttributeType: S
        - AttributeName: customerPhone
          AttributeType: S
        - AttributeName: orderTime
          AttributeType: S
      KeySchema:
        - AttributeName: orderId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CustomerPhoneIndex
          KeySchema:
            - AttributeName: customerPhone
              KeyType: HASH
            - AttributeName: orderTime
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:GetItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:UpdateItem'
                  - 'dynamodb:Query'
                  - 'dynamodb:Scan'
                Resource:
                  - !GetAtt OrdersTable.Arn
                  - !Sub '${OrdersTable.Arn}/index/*'

  # Notification Lambda Function
  NotificationFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: food-ordering-notifications-v2
      Runtime: nodejs18.x
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      Code:
        ZipFile: |
          const https = require('https');
          
          exports.handler = async (event) => {
            console.log('Event:', JSON.stringify(event));
            
            const body = JSON.parse(event.body || '{}');
            const { orderDetails, customerPhone } = body;
            
            const twilioAccountSid = process.env.TWILIO_ACCOUNT_SID;
            const twilioAuthToken = process.env.TWILIO_AUTH_TOKEN;
            const twilioWhatsApp = process.env.TWILIO_WHATSAPP_NUMBER;
            const twilioSms = process.env.TWILIO_SMS_NUMBER;
            const restaurantWhatsApp = process.env.RESTAURANT_WHATSAPP_NUMBER;
            
            // Format message
            const message = `ðŸ”” NEW ORDER!\n\nOrder ID: ${orderDetails.orderId}\nCustomer: ${orderDetails.customerName}\nPhone: ${customerPhone}\nItems: ${orderDetails.items}\nTotal: â‚¹${orderDetails.total}\nAddress: ${orderDetails.address}`;
            
            try {
              // Send WhatsApp to restaurant
              await sendTwilioMessage(
                twilioAccountSid,
                twilioAuthToken,
                twilioWhatsApp,
                restaurantWhatsApp,
                message
              );
              
              // Send SMS to customer
              const customerMessage = `Thank you for your order! Order ID: ${orderDetails.orderId}. Total: â‚¹${orderDetails.total}. We'll deliver in 30 minutes.`;
              await sendTwilioMessage(
                twilioAccountSid,
                twilioAuthToken,
                twilioSms,
                customerPhone,
                customerMessage
              );
              
              return {
                statusCode: 200,
                headers: {
                  'Access-Control-Allow-Origin': '*',
                  'Access-Control-Allow-Headers': 'Content-Type',
                  'Access-Control-Allow-Methods': 'POST,OPTIONS'
                },
                body: JSON.stringify({ success: true, message: 'Notifications sent' })
              };
            } catch (error) {
              console.error('Error:', error);
              return {
                statusCode: 500,
                headers: {
                  'Access-Control-Allow-Origin': '*'
                },
                body: JSON.stringify({ success: false, error: error.message })
              };
            }
          };
          
          function sendTwilioMessage(accountSid, authToken, from, to, body) {
            return new Promise((resolve, reject) => {
              const auth = Buffer.from(`${accountSid}:${authToken}`).toString('base64');
              const postData = new URLSearchParams({
                From: from,
                To: to,
                Body: body
              }).toString();
              
              const options = {
                hostname: 'api.twilio.com',
                port: 443,
                path: `/2010-04-01/Accounts/${accountSid}/Messages.json`,
                method: 'POST',
                headers: {
                  'Authorization': `Basic ${auth}`,
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'Content-Length': postData.length
                }
              };
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => data += chunk);
                res.on('end', () => {
                  if (res.statusCode === 201) {
                    resolve(JSON.parse(data));
                  } else {
                    reject(new Error(`Twilio error: ${data}`));
                  }
                });
              });
              
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }
      Environment:
        Variables:
          TWILIO_ACCOUNT_SID: !Ref TwilioAccountSid
          TWILIO_AUTH_TOKEN: !Ref TwilioAuthToken
          TWILIO_WHATSAPP_NUMBER: !Ref TwilioWhatsAppNumber
          TWILIO_SMS_NUMBER: !Ref TwilioSmsNumber
          RESTAURANT_WHATSAPP_NUMBER: !Ref RestaurantWhatsAppNumber
          RESTAURANT_SMS_NUMBER: !Ref RestaurantSmsNumber

  # API Gateway
  ApiGateway:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: food-ordering-simple-api
      ProtocolType: HTTP
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowHeaders:
          - '*'

  # Lambda Integration
  ApiIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref ApiGateway
      IntegrationType: AWS_PROXY
      IntegrationUri: !GetAtt NotificationFunction.Arn
      PayloadFormatVersion: '2.0'

  # API Route
  ApiRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref ApiGateway
      RouteKey: 'POST /send-notification'
      Target: !Sub 'integrations/${ApiIntegration}'

  # API Stage
  ApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref ApiGateway
      StageName: '$default'
      AutoDeploy: true

  # Lambda Permission
  LambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref NotificationFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*'

Outputs:
  ApiUrl:
    Description: API Gateway URL
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com'
  
  FunctionName:
    Description: Lambda Function Name
    Value: !Ref NotificationFunction
    
  OrdersTableName:
    Description: Orders DynamoDB Table Name
    Value: !Ref OrdersTable